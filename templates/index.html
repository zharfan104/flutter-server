{% extends "base.html" %}

{% block title %}Flutter Development Studio{% endblock %}

{% block content %}
<!-- Critical Error Alert (Hidden by default) -->
<div id="critical-error-alert" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none; margin-bottom: 1rem;">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>System Error:</strong> <span id="critical-error-message"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Status Bar -->
<div class="row mb-3">
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="card text-white bg-primary">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Flutter Status</h6>
                        <small id="flutter-status-text">Checking...</small>
                    </div>
                    <i class="bi bi-phone-flip"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="card text-white bg-success">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Hot Reloads</h6>
                        <small id="reload-count">0</small>
                    </div>
                    <i class="bi bi-arrow-clockwise"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="card text-white bg-info">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">AI Assistant</h6>
                        <small id="ai-status">Ready</small>
                    </div>
                    <i class="bi bi-robot"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-2">
        <div class="card text-white bg-warning">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Actions</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-sm btn-light" onclick="startFlutter()" title="Start Flutter">
                                <i class="bi bi-play-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-light" onclick="hotReload()" title="Hot Reload">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="row" style="height: calc(100vh - 200px);">
    <!-- Flutter App with Tabs -->
    <div class="col-lg-8 mb-3">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <h6 class="card-title mb-0">
                    <i class="bi bi-phone text-primary"></i>
                    Flutter App Preview
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="refreshApp()" title="Refresh App">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="openFullScreen()" title="Open in New Tab">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column" style="height: calc(100vh - 260px);">
                <!-- Tabs -->
                <ul class="nav nav-tabs px-3 pt-2" id="preview-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="app-preview-tab" data-bs-toggle="tab" 
                                data-bs-target="#app-preview-panel" type="button" role="tab">
                            <i class="bi bi-phone"></i> App Preview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="code-generation-tab" data-bs-toggle="tab" 
                                data-bs-target="#code-generation-panel" type="button" role="tab">
                            <i class="bi bi-code-slash"></i> Live Code Generation
                            <span id="code-gen-badge" class="badge bg-danger ms-1" style="display: none;">●</span>
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content flex-grow-1 overflow-hidden">
                    <!-- App Preview Tab -->
                    <div class="tab-pane fade show active h-100" id="app-preview-panel" role="tabpanel">
                        <div class="position-relative h-100">
                            <iframe id="flutter-app" src="/app" 
                                    style="width: 100%; height: 100%; border: none;"
                                    title="Flutter App">
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <div class="text-center">
                                        <i class="bi bi-phone-fill text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">Flutter app will appear here once started.</p>
                                        <button class="btn btn-primary" onclick="startFlutter()">Start Flutter</button>
                                    </div>
                                </div>
                            </iframe>
                    
                            <!-- Loading overlay -->
                            <div id="flutter-loading-overlay" 
                                 class="position-absolute top-0 start-0 w-100 h-100"
                                 style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); z-index: 10;">
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <h6 class="text-primary mb-2">Loading Flutter App...</h6>
                                        <p class="text-muted small mb-0">Please wait while the app initializes</p>
                                        
                                        <!-- Countdown Timer -->
                                        <div class="mt-3 mb-3">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="bi bi-clock text-info me-2"></i>
                                                <span id="flutter-loading-timer" class="badge bg-info fs-6 px-3 py-2">15s</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Progress Bar -->
                                        <div class="mt-2">
                                            <div class="progress" style="width: 250px; height: 6px;">
                                                <div id="flutter-loading-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%; transition: width 0.5s ease;"></div>
                                            </div>
                                            <small class="text-muted mt-1 d-block">Initializing Flutter runtime...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Code Generation Tab -->
                    <div class="tab-pane fade h-100" id="code-generation-panel" role="tabpanel">
                        <div class="p-3 h-100 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <span id="currentFile" class="text-muted">Waiting for code generation...</span>
                                </h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearCodePreview()" title="Clear">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div id="code-preview-container" class="flex-grow-1" style="background: #1e1e1e; border-radius: 8px; overflow: hidden;">
                                <pre style="background: #1e1e1e; color: #d4d4d4; padding: 15px; margin: 0; height: 100%; overflow-y: auto; font-family: 'Courier New', Consolas, monospace; font-size: 0.9rem;">
                                    <code id="codePreview"></code>
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Chat Assistant -->
    <div class="col-lg-4 mb-3">
        <div class="card h-100 d-flex flex-column">
            <!-- Chat Header -->
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <h6 class="card-title mb-0">
                    <i class="bi bi-robot text-primary"></i>
                    AI Assistant
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="startNewConversation()" title="New Chat">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearCurrentConversation()" title="Clear Chat">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            
            <!-- Messages Container -->
            <div class="card-body p-2 flex-grow-1 d-flex flex-column" style="min-height: 0; height: calc(100vh - 350px);">
                <div id="messages-container" class="flex-grow-1 mb-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; padding: 12px; overflow-y: auto; height: 100%; min-height: 300px;">
                    <!-- Welcome message -->
                    <div id="welcome-message" class="text-center text-muted py-3">
                        <div class="mb-2">
                            <i class="bi bi-chat-dots display-6 text-primary"></i>
                        </div>
                        <h6>Flutter AI Assistant</h6>
                        <p class="small">Ask me anything about Flutter development!</p>
                        <div class="d-grid gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="quickChatMessage('Add a login screen')">
                                Add login screen
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="quickChatMessage('Create a settings page')">
                                Create settings page
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="quickChatMessage('Fix navigation')">
                                Fix navigation
                            </button>
                            <a href="/streaming-demo" class="btn btn-sm btn-warning">
                                <i class="bi bi-magic me-1"></i>Try AI Streaming Demo
                            </a>
                        </div>
                    </div>
                    
                    <!-- Messages will be displayed here -->
                </div>
                
                <!-- Typing indicator -->
                <div id="typing-indicator" class="px-2 py-1" style="display: none;">
                    <div class="d-flex align-items-center text-muted">
                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                            <i class="bi bi-robot text-white small"></i>
                        </div>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <small class="ms-2">AI is thinking...</small>
                    </div>
                </div>
                
                <!-- Message Input -->
                <div class="mt-auto">
                    <form id="chat-form" class="d-flex gap-2">
                        <div class="flex-grow-1">
                            <div class="input-group input-group-sm">
                                <textarea 
                                    id="message-input" 
                                    class="form-control" 
                                    placeholder="Ask about Flutter..." 
                                    rows="1"
                                    style="resize: none; min-height: 32px; max-height: 80px;"
                                ></textarea>
                                <button 
                                    type="submit" 
                                    class="btn btn-primary" 
                                    id="send-button"
                                    disabled
                                >
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                            <small class="text-muted">Press Enter to send</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Monitoring Dashboard -->
<div class="row">
    <div class="col-12 mb-3">
        <div class="card shadow-sm" style="background-color: #ffffff !important; border: 1px solid #e0e0e0; border-radius: 8px;">
            <div class="card-header d-flex justify-content-between align-items-center py-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;">
                <h6 class="card-title mb-0 text-dark fw-bold">
                    <i class="bi bi-activity text-primary me-1"></i>
                    Monitoring
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-sm btn-primary" onclick="toggleMonitoringCollapse()" id="collapse-btn" title="Toggle Dashboard">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllLogs()" title="Clear All Logs">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0" id="monitoring-content">
                <!-- Monitoring Tabs -->
                <ul class="nav nav-tabs" id="monitoring-tabs" role="tablist" style="background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 0 12px;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-medium" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-panel" type="button" role="tab" style="color: #495057; border: none; background: transparent; padding: 8px 16px;">
                            <i class="bi bi-journal-text text-info"></i> Logs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-medium" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab" style="color: #495057; border: none; background: transparent; padding: 8px 16px;">
                            <i class="bi bi-speedometer2 text-warning"></i> Performance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-medium" id="debug-tab" data-bs-toggle="tab" data-bs-target="#debug" type="button" role="tab" style="color: #495057; border: none; background: transparent; padding: 8px 16px;">
                            <i class="bi bi-bug text-success"></i> Debug
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="monitoring-tab-content">
                    <!-- System Logs Tab -->
                    <div class="tab-pane fade show active" id="logs-panel" role="tabpanel" style="height: 200px; background: #ffffff;">
                        <div class="p-2">
                            <!-- Log Controls -->
                            <div class="d-flex gap-2 mb-2 flex-wrap">
                                <select class="form-select form-select-sm" id="log-level-filter" style="background-color: #ffffff !important; color: #212529 !important; border: 1px solid #ced4da !important; width: 100px;">
                                    <option value="all" style="background-color: #ffffff !important; color: #212529 !important;">All Levels</option>
                                    <option value="error" style="background-color: #ffffff !important; color: #212529 !important;">Errors</option>
                                    <option value="warn" style="background-color: #ffffff !important; color: #212529 !important;">Warnings</option>
                                    <option value="info" style="background-color: #ffffff !important; color: #212529 !important;">Info</option>
                                    <option value="debug" style="background-color: #ffffff !important; color: #212529 !important;">Debug</option>
                                </select>
                                <select class="form-select form-select-sm" id="log-category-filter" style="background-color: #ffffff !important; color: #212529 !important; border: 1px solid #ced4da !important; width: 120px;">
                                    <option value="all" style="background-color: #ffffff !important; color: #212529 !important;">All Categories</option>
                                    <option value="system" style="background-color: #ffffff !important; color: #212529 !important;">System</option>
                                    <option value="pipeline" style="background-color: #ffffff !important; color: #212529 !important;">Pipeline</option>
                                    <option value="llm" style="background-color: #ffffff !important; color: #212529 !important;">LLM</option>
                                    <option value="code_mod" style="background-color: #ffffff !important; color: #212529 !important;">Code Mod</option>
                                    <option value="flutter" style="background-color: #ffffff !important; color: #212529 !important;">Flutter</option>
                                </select>
                                <input type="text" class="form-control form-control-sm flex-grow-1" id="log-search" placeholder="Search..." style="background-color: #ffffff !important; color: #212529 !important; border: 1px solid #ced4da !important; min-width: 120px;">
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()" title="Refresh Logs">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()" title="Clear Logs">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Logs Display -->
                            <div id="logs" class="logs-container border rounded" style="height: 150px; overflow-y: auto; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; font-size: 0.75rem; background: #ffffff; padding: 8px; color: #212529; line-height: 1.3;">
                                <div class="text-center py-3">
                                    <i class="bi bi-journal-text text-info"></i>
                                    <div class="mt-1 text-dark small">System activity will appear here...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Tab -->
                    <div class="tab-pane fade" id="performance" role="tabpanel" style="height: 200px; background: #ffffff;">
                        <div class="p-2">
                            <div class="row g-2">
                                <div class="col-md-5">
                                    <h6 class="text-dark fw-medium mb-2 small">System Resources</h6>
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-dark">CPU</small>
                                            <small id="cpu-percentage" class="text-primary fw-bold">0%</small>
                                        </div>
                                        <div class="progress" style="height: 8px; background-color: #e9ecef; border-radius: 4px;">
                                            <div id="cpu-usage" class="progress-bar bg-primary" role="progressbar" style="width: 0%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-dark">Memory</small>
                                            <small id="memory-percentage" class="text-warning fw-bold">0%</small>
                                        </div>
                                        <div class="progress" style="height: 8px; background-color: #e9ecef; border-radius: 4px;">
                                            <div id="memory-usage" class="progress-bar bg-warning" role="progressbar" style="width: 0%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <h6 class="text-dark fw-medium mb-2 small">Operations</h6>
                                    <div id="performance-metrics" class="border rounded" style="height: 140px; overflow-y: auto; font-size: 0.75rem; background: #f8f9fa; padding: 8px; color: #212529;">
                                        <div class="text-center mt-3">
                                            <i class="bi bi-speedometer2 text-warning"></i>
                                            <div class="mt-1 text-dark small">Performance data will appear here</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Tab -->
                    <div class="tab-pane fade" id="debug" role="tabpanel" style="height: 200px; background: #ffffff;">
                        <div class="p-2">
                            <div class="d-flex gap-2 mb-2">
                                <button class="btn btn-sm btn-primary" onclick="loadDebugInfo()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-sm btn-success" onclick="exportLogs()">
                                    <i class="bi bi-download"></i> Export
                                </button>
                            </div>
                            <div id="debug-info" class="border rounded" style="height: 150px; overflow-y: auto; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; font-size: 0.75rem; background: #f8f9fa; padding: 8px; color: #212529; line-height: 1.3;">
                                <div class="text-center py-3">
                                    <i class="bi bi-bug text-success"></i>
                                    <div class="mt-1 text-dark small">Debug information will appear here...</div>
                                    <small class="text-secondary">Click Refresh to load system information</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Advanced Monitoring Dashboard Styles */
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    animation: pulse 2s infinite;
}

.status-indicator.bg-success {
    background-color: #28a745 !important;
}

.status-indicator.bg-warning {
    background-color: #ffc107 !important;
}

.status-indicator.bg-danger {
    background-color: #dc3545 !important;
}

.status-indicator.bg-secondary {
    background-color: #6c757d !important;
    animation: none;
}

@keyframes pulse {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
    100% {
        opacity: 1;
    }
}

.pipeline-steps .step-item {
    padding: 6px 8px;
    margin-bottom: 4px;
    border-radius: 4px;
    border-left: 3px solid #e9ecef;
    background: #ffffff;
    color: #212529 !important;
    border: 1px solid #e9ecef;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.pipeline-steps .step-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pipeline-steps .step-item.active {
    border-left-color: #007bff;
    background: #f8f9ff;
    color: #212529 !important;
    border-color: #007bff;
}

.pipeline-steps .step-item.completed {
    border-left-color: #28a745;
    background: #f8fff8;
    color: #212529 !important;
    border-color: #28a745;
}

.pipeline-steps .step-item.failed {
    border-left-color: #dc3545;
    background: #fff8f8;
    color: #212529 !important;
    border-color: #dc3545;
}

.pipeline-steps .step-item strong {
    color: #212529 !important;
    font-size: 0.8rem;
}

.pipeline-steps .step-item .text-muted {
    color: #6c757d !important;
    font-size: 0.75rem;
}

/* Terminal-style log entries - FIXED VERSION */
.logs-container .log-entry {
    padding: 3px 8px;
    margin-bottom: 1px;
    border-radius: 0;
    line-height: 1.4;
    color: #212529 !important;
    word-wrap: break-word;
    border-left: 3px solid transparent;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Courier New', monospace !important;
    font-size: 0.75rem !important;
    font-weight: 400;
    display: block;
    background: transparent;
    border: none;
    white-space: nowrap;
    overflow-x: auto;
}

.logs-container .log-entry.log-error {
    border-left-color: #dc3545 !important;
    color: #dc3545 !important;
}

.logs-container .log-entry.log-warn {
    border-left-color: #ffc107 !important;
    color: #ff8c00 !important;
}

.logs-container .log-entry.log-info {
    border-left-color: #17a2b8 !important;
    color: #17a2b8 !important;
}

.logs-container .log-entry.log-debug {
    border-left-color: #6c757d !important;
    color: #6c757d !important;
}

/* All child elements should be inline and inherit color */
.logs-container .log-entry * {
    color: inherit !important;
    font-family: inherit !important;
    display: inline !important;
    font-size: inherit !important;
    line-height: inherit !important;
    margin: 0 !important;
    padding: 0 !important;
    vertical-align: baseline !important;
}

/* Specific spacing for badges */
.logs-container .log-entry .badge {
    margin-right: 4px !important;
    padding: 2px 4px !important;
    border-radius: 3px !important;
    font-size: 0.65rem !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    display: inline !important;
}

/* Level badges - distinct colors for each level */
.logs-container .log-entry.log-error .badge:first-of-type,
.logs-container .log-entry .bg-danger {
    background-color: #dc3545 !important;
    color: #ffffff !important;
}

.logs-container .log-entry.log-warn .badge:first-of-type,
.logs-container .log-entry .bg-warning {
    background-color: #fd7e14 !important;
    color: #ffffff !important;
}

.logs-container .log-entry.log-info .badge:first-of-type,
.logs-container .log-entry .bg-info {
    background-color: #0dcaf0 !important;
    color: #000000 !important;
}

.logs-container .log-entry.log-debug .badge:first-of-type,
.logs-container .log-entry .bg-secondary {
    background-color: #6c757d !important;
    color: #ffffff !important;
}

/* Category badges (FLUTTER, SYSTEM, etc.) - always dark background */
.logs-container .log-entry .badge:not(:first-of-type),
.logs-container .log-entry .badge.bg-secondary {
    background-color: #495057 !important;
    color: #ffffff !important;
}

/* Override monitoring content rules for badges specifically */
#monitoring-content .logs-container .log-entry .badge {
    color: #ffffff !important;
}

#monitoring-content .logs-container .log-entry.log-info .badge:first-of-type {
    background-color: #0dcaf0 !important;
    color: #000000 !important;
}

#monitoring-content .logs-container .log-entry .badge:not(:first-of-type) {
    background-color: #495057 !important;
    color: #ffffff !important;
}

/* Ensure all badges have proper contrast */
.logs-container .log-entry .badge {
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
}

/* Timestamp spacing */
.logs-container .log-entry .log-timestamp {
    margin-right: 6px !important;
    color: #6c757d !important;
    font-weight: 500 !important;
}

/* Category badge spacing */
.logs-container .log-entry .badge + .badge {
    margin-left: 2px !important;
}

/* Override monitoring content rules */
#monitoring-content .logs-container .log-entry.log-error,
#monitoring-content .logs-container .log-entry.log-error * {
    color: #dc3545 !important;
}

#monitoring-content .logs-container .log-entry.log-warn,
#monitoring-content .logs-container .log-entry.log-warn * {
    color: #ff8c00 !important;
}

#monitoring-content .logs-container .log-entry.log-info,
#monitoring-content .logs-container .log-entry.log-info * {
    color: #17a2b8 !important;
}

#monitoring-content .logs-container .log-entry.log-debug,
#monitoring-content .logs-container .log-entry.log-debug * {
    color: #6c757d !important;
}

/* Badge colors override */
#monitoring-content .logs-container .log-entry .badge {
    color: #ffffff !important;
    background-color: currentColor !important;
}

/* Hover effect */
.logs-container .log-entry:hover {
    background-color: rgba(0, 0, 0, 0.03) !important;
}

/* Chat-specific styles for the integrated view */
.avatar-sm {
    width: 24px;
    height: 24px;
}

.message-bubble {
    max-width: 85%;
    word-wrap: break-word;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 12px;
}

.message-bubble.user {
    background: #007bff;
    color: white;
    margin-left: auto;
    border-radius: 12px 12px 4px 12px;
}

.message-bubble.assistant {
    background: white;
    color: #333;
    margin-right: auto;
    border-radius: 12px 12px 12px 4px;
    border: 1px solid #e9ecef;
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.7;
}

/* Typing animation */
.typing-dots {
    display: flex;
    gap: 2px;
}

.typing-dots span {
    width: 4px;
    height: 4px;
    background: #6c757d;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Auto-expanding textarea */
#message-input {
    transition: height 0.2s ease;
}

/* Force white backgrounds and dark text for all monitoring dashboard form controls */
#monitoring-content .form-select,
#monitoring-content .form-control,
#monitoring-content input,
#monitoring-content select,
#monitoring-content textarea {
    background-color: #ffffff !important;
    color: #212529 !important;
    border: 1px solid #ced4da !important;
}

#monitoring-content .form-select option {
    background-color: #ffffff !important;
    color: #212529 !important;
}

/* Override any dark theme for monitoring dashboard */
#monitoring-content,
#monitoring-content .tab-pane,
#monitoring-content .tab-content {
    background-color: #ffffff !important;
    color: #212529 !important;
}

/* Ensure all text in monitoring dashboard is dark */
#monitoring-content * {
    color: #212529 !important;
}

/* Exception for badges and buttons */
#monitoring-content .badge {
    color: #ffffff !important;
}

#monitoring-content .btn {
    color: initial !important;
}

#monitoring-content .text-primary {
    color: #007bff !important;
}

#monitoring-content .text-secondary {
    color: #6c757d !important;
}

#monitoring-content .text-danger {
    color: #dc3545 !important;
}

#monitoring-content .text-success {
    color: #28a745 !important;
}

#monitoring-content .text-warning {
    color: #ffc107 !important;
}

/* Specific overrides for dropdowns and inputs that might be affected by dark themes */
select#log-level-filter,
select#log-category-filter,
input#log-search {
    background-color: #ffffff !important;
    color: #212529 !important;
    border: 1px solid #ced4da !important;
    -webkit-appearance: menulist !important;
    -moz-appearance: menulist !important;
    appearance: menulist !important;
}

/* Force option styling */
select#log-level-filter option,
select#log-category-filter option {
    background-color: #ffffff !important;
    color: #212529 !important;
}

/* Force all monitoring dashboard elements to use light theme */
.monitoring-dashboard,
.monitoring-dashboard * {
    background-color: inherit !important;
    color: #212529 !important;
}

/* Override system dark mode preferences for this specific component */
@media (prefers-color-scheme: dark) {
    #monitoring-content,
    #monitoring-content *,
    #monitoring-content .form-select,
    #monitoring-content .form-control {
        background-color: #ffffff !important;
        color: #212529 !important;
        border-color: #ced4da !important;
    }
    
    #monitoring-content .form-select option {
        background-color: #ffffff !important;
        color: #212529 !important;
    }
}

/* Flutter Loading Overlay Styles */
#flutter-loading-overlay {
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    opacity: 1;
    visibility: visible;
}

#flutter-loading-overlay.d-none {
    opacity: 0;
    visibility: hidden;
}

#flutter-loading-overlay .spinner-border {
    animation: spin 1s linear infinite;
}

/* Animated progress bar */
#flutter-loading-overlay .progress-bar {
    position: relative;
    overflow: hidden;
}

#flutter-loading-overlay .progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: progressShine 2s ease-in-out infinite;
}

@keyframes progressShine {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}

/* Timer badge animation */
#flutter-loading-timer {
    animation: timerPulse 2s ease-in-out infinite;
}

@keyframes timerPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* Enhanced spinner */
#flutter-loading-overlay .spinner-border {
    animation: spin 1.5s linear infinite;
}

/* Code highlighting in messages */
.message-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 8px;
    margin: 4px 0;
    overflow-x: auto;
    font-size: 0.75rem;
}

.message-content code {
    background: #f8f9fa;
    padding: 1px 3px;
    border-radius: 2px;
    font-size: 0.75rem;
}

.message-content pre code {
    background: none;
    padding: 0;
}

/* AI Assistant Chat Scrolling Fix */
#messages-container {
    scrollbar-width: thin;
    scrollbar-color: #6c757d #f8f9fa;
}

#messages-container::-webkit-scrollbar {
    width: 6px;
}

#messages-container::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
}

#messages-container::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 3px;
}

#messages-container::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

/* Ensure messages container maintains proper height */
.card.h-100 .card-body {
    overflow: hidden;
}

/* Message bubbles responsive sizing */
.message-bubble {
    max-width: 90%;
    word-wrap: break-word;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 12px;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* Code generation preview styles */
.typing-cursor {
    animation: blink 1s infinite;
    font-weight: bold;
    color: #0d6efd;
}

@keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
}

#code-preview-container pre {
    background: #1e1e1e;
    color: #d4d4d4;
    scrollbar-width: thin;
    scrollbar-color: #3e3e3e #1e1e1e;
}

#code-preview-container pre::-webkit-scrollbar {
    width: 8px;
}

#code-preview-container pre::-webkit-scrollbar-track {
    background: #1e1e1e;
}

#code-preview-container pre::-webkit-scrollbar-thumb {
    background: #3e3e3e;
    border-radius: 4px;
}

#code-preview-container pre::-webkit-scrollbar-thumb:hover {
    background: #4e4e4e;
}

/* Tab styles */
#preview-tabs {
    border-bottom: 1px solid #dee2e6;
}

#preview-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 0.5rem 1rem;
}

#preview-tabs .nav-link:hover {
    color: #495057;
    border-bottom-color: #dee2e6;
}

#preview-tabs .nav-link.active {
    color: #0d6efd;
    background: none;
    border-bottom-color: #0d6efd;
}

/* Badge animation */
#code-gen-badge {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
// Additional functions for integrated view
function openFullScreen() {
    window.open('/app', '_blank');
}

function quickChatMessage(message) {
    // Use ChatManager if available, otherwise open chat page
    if (window.chatManager && window.chatManager.sendMessage) {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.value = message;
            messageInput.dispatchEvent(new Event('input'));
            // Use ChatManager's sendMessage directly to avoid double event handling
            window.chatManager.sendMessageStream();
        }
    } else {
        // Fallback: open chat page in new tab
        const chatUrl = `/chat?message=${encodeURIComponent(message)}`;
        window.open(chatUrl, '_blank');
    }
}

// Code preview functions
function updateCodePreview(fileName, content) {
    document.getElementById('currentFile').textContent = fileName || 'Generating...';
    const codeEl = document.getElementById('codePreview');
    // Replace \n with actual line breaks after escaping HTML
    const formattedContent = escapeHtml(content).replace(/\\n/g, '\n');
    codeEl.innerHTML = formattedContent + '<span class="typing-cursor">▋</span>';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearCodePreview() {
    document.getElementById('currentFile').textContent = 'Waiting for code generation...';
    document.getElementById('codePreview').innerHTML = '';
}

function switchToCodeGenTab() {
    const codeGenTab = document.getElementById('code-generation-tab');
    const codeGenBadge = document.getElementById('code-gen-badge');
    
    // Show badge
    codeGenBadge.style.display = 'inline';
    
    // Switch to code generation tab
    const tab = new bootstrap.Tab(codeGenTab);
    tab.show();
}

function switchToAppPreviewTab() {
    const appPreviewTab = document.getElementById('app-preview-tab');
    const codeGenBadge = document.getElementById('code-gen-badge');
    
    // Hide badge
    codeGenBadge.style.display = 'none';
    
    // Switch to app preview tab
    const tab = new bootstrap.Tab(appPreviewTab);
    tab.show();
}

// Initialize both dashboard and chat functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chat if the functions exist
    if (typeof initializeChat === 'function') {
        initializeChat();
    }
    
    // Initialize advanced logging and monitoring
    if (typeof initializeAdvancedLogging === 'function') {
        initializeAdvancedLogging();
    }
    
    // Initialize pipeline monitoring
    if (typeof monitorChatRequests === 'function') {
        monitorChatRequests();
    }
    
    // Initialize performance monitoring
    if (typeof initializePerformanceMonitoring === 'function') {
        initializePerformanceMonitoring();
    }
    
    // Update AI status
    document.getElementById('ai-status').textContent = 'Ready';
    
    // Auto-start Flutter if not running
    setTimeout(() => {
        checkStatus();
    }, 1000);
});
</script>
{% endblock %}